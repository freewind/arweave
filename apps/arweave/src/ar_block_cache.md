 # ar_block_cache 模块解析

## 模块功能

本模块维护一个已通过工作量证明(PoW)验证的区块有向无环图(DAG)，使用ETS表存储。主要用于管理区块的验证状态、处理分叉，以及维护最长链。

## 核心概念

### 1. 区块状态

区块在缓存中有以下几种状态：

- on_chain: 区块已验证且在当前最长链上
- validated: 区块已验证但不在当前最长链上
- not_validated: 区块尚未验证
- none: 空状态

### 2. 数据结构

使用ETS表存储以下数据：

1. 区块信息
    - 键: {block, BlockHash}
    - 值: {区块数据, 状态, 时间戳, 子区块集合}

2. 最大难度
    - 键: max_cdiff
    - 值: {累积难度, 区块哈希}

3. 解决方案映射
    - 键: {solution, SolutionHash}
    - 值: 区块哈希集合

4. 最长链缓存
    - 键: longest_chain
    - 值: [{区块哈希, 交易ID列表}]

5. 链尖指针
    - 键: tip
    - 值: 区块哈希

6. 高度索引
    - 键: links
    - 值: {高度, 区块哈希}集合

## 主要功能

### 1. 区块管理

- new/2: 创建新缓存
- add/2: 添加未验证区块
- add_validated/2: 添加已验证区块
- remove/2: 移除区块
- get/2: 获取区块

### 2. 状态跟踪

- mark_nonce_limiter_validated/2: 标记区块通过nonce限制器验证
- mark_tip/2: 标记区块为链尖
- get_block_and_status/2: 获取区块及其状态

### 3. 分叉处理

- get_fork_length/2: 计算分叉长度
- get_siblings/2: 获取兄弟区块
- get_fork_blocks/2: 获取分叉区块

### 4. 缓存维护

- prune/2: 裁剪旧区块
- remove_expired_alternative_blocks/2: 移除过期的替代区块

## 实现细节

### 1. 替代区块过期

- 基于分叉长度计算过期时间
- 默认基础过期时间为5秒
- 实际过期时间 = 基础时间 * 分叉长度

### 2. 分叉处理

当发现更长的分叉时：
1. 计算累积难度
2. 比较与当前链的难度
3. 必要时切换到新分叉

### 3. 性能优化

- 使用ETS表提供高效的内存存储
- 通过高度索引加速区块查找
- 维护最长链缓存减少重复计算

## 注意事项

1. 并发安全
    - 不建议从不同进程修改状态
    - 可能导致数据不一致

2. 内存使用
    - 需要监控ETS表大小
    - 及时裁剪旧区块

3. 分叉处理
    - 需要正确处理分叉切换
    - 保持状态一致性